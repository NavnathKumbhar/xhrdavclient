<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Resource Builder Test</title>
  <script src="../closure-library/closure/goog/base.js" type="text/javascript"></script>
  <script src="../xhrdavclientdeps.js" type="text/javascript"></script>
  <script src="utils.js" type="text/javascript"></script>
</head>
<body>
  <script type="text/javascript">
    goog.require('goog.testing.jsunit');
    goog.require('goog.debug.Console');
    goog.require('goog.debug.Logger');
    goog.require('goog.json');

    goog.require('xhrdav.lib.ResourceBuilder');
    goog.require('xhrdav.lib.HttpStatus');
  </script>
  <script type="text/javascript">
    goog.debug.Console.autoInstall();
    goog.debug.Console.instance.setCapturing(true);

    var initDirOnlyData, initCurrDirData;
    var httpStatus = xhrdav.lib.HttpStatus;
    var httpStatusText = xhrdav.lib.HttpStatus.text;

    // Load fixture by jsonp
    var fixtureDirOnlyData;
    var multistatusDironlyParseRaw = function(json) {
      fixtureDirOnlyData = json;
    };
    loadJson('../fixtures/multistatusDironlyParseRaw.js');

    var fixtureCurrDirData;
    var multistatusCurrentDirParseRaw = function(json) {
      fixtureCurrDirData = json;
    };
    loadJson('../fixtures/multistatusCurrentDirParseRaw.js');

    function setUp() {
      initDirOnlyData = fixtureDirOnlyData['json'];
      initCurrDirData = fixtureCurrDirData['json'];
    }

    function tearDown() {
      initDirOnlyData = initCurrDirData = null;
    }

    function testNewBuilder() {
      var testId = 'NewBuilder';
      var logger = new goog.debug.Logger.getLogger(testId);

      var builder = new xhrdav.lib.ResourceBuilder();
      assertNotNullNorUndefined('Create instance?', builder);
      assertNotUndefined('Defined property: rawData?', builder.getRawData);
      assertNotUndefined('Defined property: resource?', builder.getResources);
    }

    function testCreateResoruce() {
      var testId = 'CreateResource';
      var logger = new goog.debug.Logger.getLogger(testId);

      var builder = xhrdav.lib.ResourceBuilder.createCollection(initCurrDirData);
      assertNotNullNorUndefined('Set rawData?', builder.getRawData());
      assertNotEquals('Contains D:response?',
        0, goog.object.getCount(builder.getRawData().D$response));
//      logger.config(goog.object.getCount(builder.getRawData().D$response));
//      logger.config(goog.json.serialize(builder.getRawData().D$response[0]));

      assertNotNullNorUndefined('Get Resources', builder.getResources());
//      logger.config(goog.json.serialize(builder.getResources()));
      assertNotNullNorUndefined('root', builder.getResources().root);
      assertNotNullNorUndefined('childs', builder.getResources().childs);
      assertEquals('Resource Childs count = rawData D:response count - 1',
        goog.object.getCount(builder.getRawData().D$response) - 1,
        goog.object.getCount(builder.getResources().childs));
    }

    /*
      Directory Json/Hash repr
      {status: 'HTTP/1.1 200 OK', statuscode: 200, statustext: 'OK', protocol: 'HTTP/1.1',
       resourcetype: 'collection', creationdate: <date>, lastmodified: <date>,
       etag: '"134fab1458-1234-fefa018070431"', contenttype: 'http/unix-directry',
       [lockdiscovery: LOCK時のプロパティ 未確定] =>{activelock: {
        locktype: 'write',
        lockscope: 'exclusive'
        depth: 0
        owner: 'Jame Smith',
        timeout: [# | Infinite],
        locktoken: {href: {opaquelocktoken: 'f81de2ad-7f3d'}},
       }
      }

      File Json/Hash repr
      {status: 'HTTP/1.1 200 OK', statuscode: 200, statustext: 'OK', protocol: 'HTTP/1.1',
       resourcetype: 'collection', creationdate: <date>, lastmodified: <date>,
       etag: '"134fab1458-1234-fefa018070431"', contenttype: 'http/unix-directry',
       [lockdiscovery: ?] <= 不明
      }
     */
  </script>
</body>
</html>
