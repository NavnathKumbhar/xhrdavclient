<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>WebDAV FS Directories Test</title>
  <script src="../closure-library/closure/goog/base.js" type="text/javascript"></script>
  <script src="../xhrdavclientdeps.js" type="text/javascript"></script>
  <script src="utils.js" type="text/javascript"></script>
  <script type="text/javascript">
    goog.require('goog.testing.AsyncTestCase');
    goog.require('goog.testing.jsunit');
    goog.require('goog.debug.Console');
    goog.require('goog.debug.Logger');

    goog.require('goog.object');
    goog.require('goog.string.path');
    goog.require('goog.net.XhrManager');
    goog.require('xhrdav.lib.DavFs');
    goog.require('goog.ds.XmlDataSource');
    goog.require('goog.ds.DataManager');
    goog.require('goog.array');
    goog.require('goog.dom.xml');
  </script>
</head>
<body>
  <script type="text/javascript">
    goog.debug.Console.autoInstall();
    goog.debug.Console.instance.setCapturing(true);

    // Prepare AsyncTest
    var asyncTestCase = goog.testing.AsyncTestCase.createAndInstall();
    var asyncContinue = function() {
      asyncTestCase.continueTesting();
    };

    function testListDirByNullPath() {
      var testId = 'ListDirByNullPath()';
      var logger = goog.debug.Logger.getLogger(testId);

      asyncTestCase.waitForAsync(testId);

      var dir = null;

      var fs = xhrdav.lib.DavFs.Instance.initialize();
      var httpStatus = xhrdav.lib.HttpStatus;
      var httpStatusText = xhrdav.lib.HttpStatus.text;

//      var assertListDir = function(content, 

      fs.listDir(dir, assertListDir, null, goog.partial(xhrLogging, logger));

      asyncContinue();
    }

    // Unfixed
    function /*test*/ListDir() {
      var testId = 'fs_directories_test#ListDir';

      asyncTestCase.waitForAsync(testId);

      var dir = '/mydav/';
      var davFs = webdav.lib.DavFs.getInstance();
      davFs.initialize();
      var httpStatus = webdav.HttpStatus;
      var httpStatusText = webdav.HttpStatus.text;

      var assertList = function(statusCode, content, headers) {
        var rootName = goog.string.path.normalizePath(dir);
        var l = goog.debug.Logger.getLogger('ds-debug');

        var rootDoc = content.documentElement;

        var ds = new goog.ds.XmlDataSource(content, null, rootName); // RootTree
        l.config("DataSourceName: " + ds.getDataName());
        l.config("DataSourcePath: " + ds.getDataPath());
//        var childNode = ds.getChildNode('D:multistatus');
//        l.config(childNode.getDataPath());
        var dm = goog.ds.DataManager.getInstance();
        dm.addDataSource(ds);
//        l.config("DM getDS: " +
//          dm.getDataSource('$' + rootName)
//            .getChildNode('D:multistatus')
//            .getChildNodes().getCount());
        var nodeList = dm.getChildNode('$' + rootName).getChildNode('D:multistatus').getChildNodes();
        var childValues = [], node;
        l.config("Count: " + nodeList.getCount());

        for (var i = 0, cnt = nodeList.getCount(); i < cnt; i++) {
          node = nodeList.getByIndex(i);
          var href = node.getChildNode('D:href').get();
          l.config(href);
          l.config(goog.string.urlDecode(href));
        }
        asyncContinue();
      };
      davFs.listDir(dir, assertList, null, goog.partial(xhrLogging, logger));
    };
  </script>
</body>
</html>
