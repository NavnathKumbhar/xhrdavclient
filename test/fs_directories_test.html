<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>WebDAV FS Directories Test</title>
  <script src="../closure-library/closure/goog/base.js" type="text/javascript"></script>
  <script src="../xhrdavclientdeps.js" type="text/javascript"></script>
  <script type="text/javascript">
    goog.require('goog.testing.AsyncTestCase');
    goog.require('goog.testing.jsunit');
    goog.require('goog.debug.Console');
    goog.require('goog.debug.Logger');

    goog.require('goog.object');
    goog.require('goog.string.path');
    goog.require('goog.net.XhrManager');
    goog.require('webdav.fs.DavFs');
    goog.require('webdav.HttpStatus');
    goog.require('goog.ds.XmlDataSource');
    goog.require('goog.array');
    goog.require('goog.dom.xml');
  </script>
</head>
<body>
  <script type="text/javascript">
    goog.debug.Console.autoInstall();
    goog.debug.Console.instance.setCapturing(true);

    /**
     * Logging for XHR
     *
     * <pre><code>
     * goog.net.XhrIo.send('/foo', function() {
     *   var xhr = e.target;
     *   logging('foo1', xhr);
     * });
     * </code></pre>
     *
     * @param {string} id Logger ID.
     * @param {Object} req XHTTPRequest object.
     * @param {Function} callback Callback function.
     */
    var logging = function(id, req, callback) {
      var logger = goog.debug.Logger.getLogger(id);
      logger.info("ID: " + id);
      logger.info("Status: " + req.getStatus() + " - " + req.getStatusText());
      logger.info("Success?: " + req.isSuccess());
      logger.info("ResponseType: " + req.getResponseType());
      logger.info("Response: " + req.getResponse());
      logger.info("Response Headers: " + req.getAllResponseHeaders());
      if (req.getLastError()) {
        logger.warning("Error?: " + req.getLastErrorCode() + " - " + req.getLastError());
      }
      if (callback) callback(id, req);
    };

    // Prepare AsyncTest
    var asyncTestCase = goog.testing.AsyncTestCase.createAndInstall();
    var asyncContinue = function() {
      asyncTestCase.continueTesting();
    };

    // Unfixed
    function testListDir() {
      var testId = 'fs_directories_test#ListDir';

      asyncTestCase.waitForAsync(testId);

      var dir = '/mydav/';
      var davFs = webdav.fs.DavFs.getInstance();
      davFs.initialize();
      var httpStatus = webdav.HttpStatus;
      var httpStatusText = webdav.HttpStatus.text;

      var assertList = function(req) {
        var rootName = 'rootTree';
        logging(testId, req);

        var resp = req.getResponseXml('while(1);');
//        var doc = goog.dom.xml.loadXml('<D:multistatus />');
//        var ds = new goog.ds.XmlDataSource(resp, doc, rootName);
        var ds = new goog.ds.XmlDataSource(resp, null, rootName); // RootTree
        var childNode = ds.getChildNode('D:multistatus');
        var l = goog.debug.Logger.getLogger('ds-debug');
        l.info(ds.getChildNode('D:multistatus').getDataPath());
        var nodeList = ds.getChildNode('D:multistatus').getChildNodes();
        var childValues = [], node;
l.info("Count: " + nodeList.getCount());
        for (var i = 0, cnt = nodeList.getCount(); i < cnt; i++) {
          node = nodeList.getByIndex(i);
          childValues[i] = node.getDataName() + ' : ' + node.getDataPath();
l.info(childValues[i]);
        }
        asyncContinue();
      };
      davFs.listDir(dir, assertList);
    };
  </script>
</body>
</html>
