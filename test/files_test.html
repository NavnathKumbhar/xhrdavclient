<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>WebDAV Files Test</title>
  <script src="../closure-library/closure/goog/base.js" type="text/javascript"></script>
  <script src="../xhrdavclientdeps.js" type="text/javascript"></script>
  <script type="text/javascript">
    goog.require('goog.testing.AsyncTestCase');
    goog.require('goog.testing.jsunit');
    goog.require('goog.debug.Console');
    goog.require('goog.debug.Logger');

    goog.require('goog.object');
    goog.require('goog.string.path');
    goog.require('goog.net.XhrManager');
    goog.require('webdav.Client');
    goog.require('webdav.HttpStatus');
  </script>
</head>
<body>
  <script type="text/javascript">
    goog.debug.Console.autoInstall();
    goog.debug.Console.instance.setCapturing(true);

    /**
     * Logging for XHR
     *
     * <pre><code>
     * goog.net.XhrIo.send('/foo', function() {
     *   var xhr = e.target;
     *   logging('foo1', xhr);
     * });
     * </code></pre>
     *
     * @param {string} id Logger ID.
     * @param {Object} req XHTTPRequest object.
     * @param {Function} callback Callback function.
     */
    var logging = function(id, req, callback) {
      var logger = goog.debug.Logger.getLogger(id);
      logger.info("ID: " + id);
      logger.info("Status: " + req.getStatus() + " - " + req.getStatusText());
      logger.info("Success?: " + req.isSuccess());
      logger.info("ResponseType: " + req.getResponseType());
      logger.info("Response: " + req.getResponse());
      logger.info("Response Headers: " + req.getAllResponseHeaders());
      if (req.getLastError()) {
        logger.warning("Error?: " + req.getLastErrorCode() + " - " + req.getLastError());
      }
      if (callback) callback(id, req);
    };

    // Prepare AsyncTest
    var asyncTestCase = goog.testing.AsyncTestCase.createAndInstall();
    var asyncContinue = function() {
      asyncTestCase.continueTesting();
    };

    var initData;
    var parentDir = '/mydav/parent/';
    var srcFile = './testwebdav.txt';
    var file = goog.string.path.join(parentDir, 'testwebdav.txt');

    function setUp() {
      asyncTestCase.waitForAsync('setUp');
      var dav = new webdav.Client();
      var processRequest = function(e) {
        var xhr = e.target;
        initData = xhr.getResponse('while(1);');
        dav.mkcol(parentDir, asyncContinue);
      };
      goog.net.XhrIo.send(srcFile, processRequest);
    }

    function tearDown() {
      asyncTestCase.waitForAsync('tearDown');
      var dav = new webdav.Client();
      dav.delete(parentDir, asyncContinue);
    }

    function testFileNotFound() {
      var testId = 'FileNotFound';

      asyncTestCase.waitForAsync(testId);

      var dummyFile = goog.string.path.join(parentDir,'foo.txt');
      var dav = new webdav.Client();
      var httpStatus = webdav.HttpStatus;
      var httpStatusText = webdav.HttpStatus.text;

      var assertNotFound = function(req) {
        assertEquals('StatusCode?', httpStatus.NOT_FOUND, req.getStatus());
        assertEquals('StatusText?',
          httpStatusText[httpStatus.NOT_FOUND],
          goog.string.trim(req.getStatusText()));
        logging(testId, req);
        asyncContinue();
      };

      dav.get(dummyFile, assertNotFound);
    }

    function testDeleteFile() {
      var testId = 'DeleteFile';

      asyncTestCase.waitForAsync(testId);

      var mgr = new goog.net.XhrManager();
      var dav = new webdav.Client();
      var httpStatus = webdav.HttpStatus;
      var httpStatusText = webdav.HttpStatus.text;

      var assertDeleteFile = function(req) {
        assertEquals('StatusCode?', httpStatus.NO_CONTENT, req.getStatus());
        assertEquals('StatusText?',
          httpStatusText[httpStatus.NO_CONTENT],
          goog.string.trim(req.getStatusText()));
        logging(testId, req);
        asyncContinue();
      };
      var callbackUploadFile = function(req) {
        dav.delete(file, assertDeleteFile, {
          xhrId: goog.string.createUniqueString(), request: mgr});
      };
      dav.put(file, initData, callbackUploadFile, {
        xhrId: goog.string.createUniqueString(), request: mgr});
    }

    function testDownloadFile() {
      var testId = 'DownloadFile';

      asyncTestCase.waitForAsync(testId);

      var mgr = new goog.net.XhrManager();
      var dav = new webdav.Client();
      var httpStatus = webdav.HttpStatus;
      var httpStatusText = webdav.HttpStatus.text;

      var assertDownloadFile = function(req) {
        assertEquals('StatusCode?', httpStatus.OK, req.getStatus());
        assertEquals('StatusText?',
          httpStatusText[httpStatus.OK],
          goog.string.trim(req.getStatusText()));
        var data = req.getResponse('while(1);');
        assertEquals('ResponseData:', initData, data);
        logging(testId, req);
        dav.delete(file, asyncContinue, {
          xhrId: goog.string.createUniqueString(), request: mgr});
      };
      var callbackUploadFile = function(req) {
        dav.get(file, assertDownloadFile);
      };
      dav.put(file, initData, callbackUploadFile, {
        xhrId: goog.string.createUniqueString(), request: mgr});
    }

    function testUploadFile() {
      var testId = 'UploadFile';

      asyncTestCase.waitForAsync(testId);

      var mgr = new goog.net.XhrManager();
      var dav = new webdav.Client();
      var httpStatus = webdav.HttpStatus;
      var httpStatusText = webdav.HttpStatus.text;

      var assertUploadFileOverWrite = function(req) {
        assertEquals('StatusCode?', httpStatus.NO_CONTENT, req.getStatus());
        assertEquals('StatusText?',
          httpStatusText[httpStatus.NO_CONTENT],
          goog.string.trim(req.getStatusText()));
        logging(testId, req);
        asyncContinue();
      };
      var assertUploadFile = function(req) {
        assertEquals('StatusCode?', httpStatus.CREATED, req.getStatus());
        assertEquals('StatusText?',
          httpStatusText[httpStatus.CREATED],
          goog.string.trim(req.getStatusText()));
        var loc = req.getResponseHeader('Location');
        assertNotNullNorUndefined('Location?', loc);
        assertTrue('Location match:', goog.string.endsWith(loc, file));
        logging(testId, req);
        dav.put(file, initData + "<MODIFIED>", assertUploadFileOverWrite, {
          xhrId: goog.string.createUniqueString(), request: mgr});
      };
      dav.put(file, initData, assertUploadFile, {
        xhrId: goog.string.createUniqueString(), request: mgr});
    }

    function testRenameFile() {
      var testId = 'RenameFile';

      asyncTestCase.waitForAsync(testId);

      var newFile = goog.string.path.join(parentDir, 'rename.txt');
      var mgr = new goog.net.XhrManager();
      var dav = new webdav.Client();
      var httpStatus = webdav.HttpStatus;
      var httpStatusText = webdav.HttpStatus.text;

      var assertRenameFile = function(req) {
        assertEquals('StatusCode?', httpStatus.CREATED, req.getStatus());
        assertEquals('StatusText?',
          httpStatusText[httpStatus.CREATED],
          goog.string.trim(req.getStatusText()));
        var loc = req.getResponseHeader('Location');
        assertNotNullNorUndefined('Location?', loc);
        assertTrue('Location match:', goog.string.endsWith(loc, newFile));
        logging(testId, req);
        asyncContinue();
      };
      var callbackUploadFile = function(req) {
        dav.move(file, newFile, assertRenameFile, {
          xhrId: goog.string.createUniqueString(), request: mgr});
      };
      dav.put(file, initData, callbackUploadFile, {
        xhrId: goog.string.createUniqueString(), request: mgr});
    }

    function testCopyFile() {
      var testId = 'CopyFile';

      asyncTestCase.waitForAsync(testId);

      var newFile = goog.string.path.join(parentDir, 'copy.txt');
      var mgr = new goog.net.XhrManager();
      var dav = new webdav.Client();
      var httpStatus = webdav.HttpStatus;
      var httpStatusText = webdav.HttpStatus.text;

      var assertCopyFileOverWriteFalse = function(req) {
        assertNotEquals('StatusCode?', httpStatus.NO_CONTENT, req.getStatus());
        logging(testId, req);
        asyncContinue();
      };
      var assertCopyFileOverWrite = function(req) {
        assertEquals('StatusCode?', httpStatus.NO_CONTENT, req.getStatus());
        assertEquals('StatusText?',
          httpStatusText[httpStatus.NO_CONTENT],
          goog.string.trim(req.getStatusText()));
        logging(testId, req);
        dav.copy(file, newFile, assertCopyFileOverWriteFalse, {
          xhrId: goog.string.createUniqueString(), request: mgr,
          overwrite: false});
      };
      var assertCopyFile = function(req) {
        assertEquals('StatusCode?', httpStatus.CREATED, req.getStatus());
        assertEquals('StatusText?',
          httpStatusText[httpStatus.CREATED],
          goog.string.trim(req.getStatusText()));
        var loc = req.getResponseHeader('Location');
        assertNotNullNorUndefined('Location?', loc);
        assertTrue('Location match:', goog.string.endsWith(loc, newFile));
        logging(testId, req);
        dav.copy(newFile, file, assertCopyFileOverWrite, {
          xhrId: goog.string.createUniqueString(), request: mgr,
          overwrite: true});
      };
      var callbackUploadFile = function(req) {
        dav.copy(file, newFile, assertCopyFile, {
          xhrId: goog.string.createUniqueString(), request: mgr});
      };
      dav.put(file, initData, callbackUploadFile, {
        xhrId: goog.string.createUniqueString(), request: mgr});
    }

    function testMoveFile() {
      var testId = 'MoveFile';

      asyncTestCase.waitForAsync(testId);

      var newFile = goog.string.path.join(parentDir, 'move.txt');
      var mgr = new goog.net.XhrManager();
      var dav = new webdav.Client();
      var httpStatus = webdav.HttpStatus;
      var httpStatusText = webdav.HttpStatus.text;

      var assertMoveFileOverWrite = function(req) {
        assertEquals('StatusCode?', httpStatus.NO_CONTENT, req.getStatus());
        assertEquals('StatusText?',
          httpStatusText[httpStatus.NO_CONTENT],
          goog.string.trim(req.getStatusText()));
        logging(testId, req);
        asyncContinue();
      };
      var assertMoveFileOverWriteFalse = function(req) {
        assertNotEquals('StatusCode?', httpStatus.NO_CONTENT, req.getStatus());
        logging(testId, req);
        dav.move(file, newFile, assertMoveFileOverWrite, {
          xhrId: goog.string.createUniqueString(), request: mgr,
          overwrite: true});
      };
      var callbackCopyFile = function(req) {
        dav.move(file, newFile, assertMoveFileOverWriteFalse, {
          xhrId: goog.string.createUniqueString(), request: mgr,
          overwrite: false});
      };
      var assertMoveFile = function(req) {
        assertEquals('StatusCode?', httpStatus.CREATED, req.getStatus());
        assertEquals('StatusText?',
          httpStatusText[httpStatus.CREATED],
          goog.string.trim(req.getStatusText()));
        var loc = req.getResponseHeader('Location');
        assertNotNullNorUndefined('Location?', loc);
        assertTrue('Location match:', goog.string.endsWith(loc, newFile));
        logging(testId, req);
        dav.copy(newFile, file, callbackCopyFile, {
          xhrId: goog.string.createUniqueString(), request: mgr});
      };
      var callbackUploadFile = function(req) {
        dav.move(file, newFile, assertMoveFile, {
          xhrId: goog.string.createUniqueString(), request: mgr});
      };
      dav.put(file, initData, callbackUploadFile, {
        xhrId: goog.string.createUniqueString(), request: mgr});
    }

  </script>
</body>
</html>
