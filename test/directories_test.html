<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>WebDAV Directories Test</title>
  <script src="../closure-library/closure/goog/base.js" type="text/javascript"></script>
  <script src="../xhrdavclientdeps.js" type="text/javascript"></script>
</head>
<body>
  <script type="text/javascript">
    goog.require('goog.testing.AsyncTestCase');
    goog.require('goog.testing.jsunit');
    goog.require('goog.debug.Console');
    goog.require('goog.debug.Logger');

    goog.require('goog.object');
    goog.require('goog.net.XhrManager');
    goog.require('webdav.lib.Client');
    goog.require('webdav.lib.HttpStatus');
  </script>
  <script type="text/javascript">
    goog.debug.Console.autoInstall();
    goog.debug.Console.instance.setCapturing(true);

    /**
     * Logging for XHR
     *
     * <pre><code>
     * goog.net.XhrIo.send('/foo', function() {
     *   var xhr = e.target;
     *   logging('foo1', xhr);
     * });
     * </code></pre>
     *
     * @param {string} id Logger ID.
     * @param {Object} req XHTTPRequest object.
     * @param {Function} callback Callback function.
     */
    var logging = function(id, req, callback) {
      var logger = goog.debug.Logger.getLogger(id);
      logger.info("ID: " + id);
      logger.info("Status: " + req.getStatus() + " - " + req.getStatusText());
      logger.info("Success?: " + req.isSuccess());
      logger.info("ResponseType: " + req.getResponseType());
      logger.info("Response: " + req.getResponse());
      logger.info("Response Headers: " + req.getAllResponseHeaders());
      if (req.getLastError()) {
        logger.warning("Error?: " + req.getLastErrorCode() + " - " + req.getLastError());
      }
      if (callback) callback(id, req);
    };

    // Prepare AsyncTest
    var asyncTestCase = goog.testing.AsyncTestCase.createAndInstall();
    var asyncContinue = function() {
      asyncTestCase.continueTesting();
    };

    function testPropfind() {
      var testId = 'Propfind';

      asyncTestCase.waitForAsync();

      var dir = '/mydav/';
      var dav = new webdav.lib.Client();
      var httpStatus = webdav.lib.HttpStatus;
      var httpStatusText = webdav.lib.HttpStatus.text;

      var assertList = function(statusCode, content, headers) {
        assertEquals('StatusCode?', httpStatus.MULTI_STATUS, statusCode);
        assertTrue('Content-Type?',
          goog.string.startsWith(headers['Content-Type'], 'text/xml;'));
        assertNotNull('ResponseXML?', content);
        assertTrue('ResposeType?', (content instanceof Document));
        asyncContinue();
      };

      dav.propfind(dir, assertList, null, goog.partial(logging, testId));
    }

    function testPropfindDepth1() {
      var testId = 'PropfindDepth1';

      asyncTestCase.waitForAsync(testId);

      var dir = '/mydav/';
      var dav = new webdav.lib.Client();
      var httpStatus = webdav.lib.HttpStatus;
      var httpStatusText = webdav.lib.HttpStatus.text;

      var assertList = function(statusCode, content, headers) {
        assertEquals('StatusCode?', httpStatus.MULTI_STATUS, statusCode);
        assertTrue('Content-Type?',
          goog.string.startsWith(headers['Content-Type'], 'text/xml;'));
        assertNotNull('ResponseXML?', content);
        assertTrue('ResposeType?', (content instanceof Document));
        asyncContinue();
      };

      dav.propfind(dir, assertList, {depth: 0}, goog.partial(logging, testId));
    }

    function testCreateAndDelete() {
      var testId = 'CreateAndDelete';

      asyncTestCase.waitForAsync(testId);

      var dir = '/mydav/foo/';
      var mgr = new goog.net.XhrManager();
      var dav = new webdav.lib.Client();
      var httpStatus = webdav.lib.HttpStatus;
      var httpStatusText = webdav.lib.HttpStatus.text;

      var assertDelete = function(statusCode, content, headers) {
        assertEquals('StatusCode?', httpStatus.NO_CONTENT, statusCode);
        assertTrue('No Content?', goog.string.isEmptySafe(content));
        asyncContinue();
      };
      var assertCreate = function(statusCode, content, headers) {
        assertEquals('StatusCode?', httpStatus.CREATED, statusCode);
        assertNotNullNorUndefined('Location?', headers['Location']);
        assertTrue('Location match:',
          goog.string.endsWith(headers['Location'], dir));
        dav._delete(dir, assertDelete, {
          xhrId: goog.string.createUniqueString(), request: mgr},
          goog.partial(logging, testId));
      };

      dav.mkcol(dir, assertCreate, {
        xhrId: goog.string.createUniqueString(), request: mgr},
        goog.partial(logging, testId));
    }

    function testRename() {
      var testId = 'Rename';

      asyncTestCase.waitForAsync(testId);

      var dir = '/mydav/bar/';
      var dstDir = '/mydav/buz/';
      var mgr = new goog.net.XhrManager();
      var dav = new webdav.lib.Client();
      var httpStatus = webdav.lib.HttpStatus;
      var httpStatusText = webdav.lib.HttpStatus.text;

      var assertRename = function(statusCode, content, headers) {
        assertEquals('StatusCode?', httpStatus.CREATED, statusCode);
        assertNotNullNorUndefined('Location?', headers['Location']);
        assertTrue('Location match:',
          goog.string.endsWith(headers['Location'], dstDir));
        dav._delete(dstDir, asyncContinue, {
          xhrId: goog.string.createUniqueString(), request: mgr},
          goog.partial(logging, testId));
      };
      var callbackCreate = function(statusCode, content, headers) {
        dav.move(dir, dstDir, assertRename, {
          xhrId: goog.string.createUniqueString(), request: mgr},
          goog.partial(logging, testId));
      };

      dav.mkcol(dir, callbackCreate, {
        xhrId: goog.string.createUniqueString(), request: mgr});
    }

    function testMove() {
      var testId = 'Move';

      asyncTestCase.waitForAsync(testId);

      var parentDir = '/mydav/parent/';
      var parentDir2 = '/mydav/parent2/';
      var dir = '/mydav/move/';
      var dstDir = '/mydav/parent/move/';
      var mgr = new goog.net.XhrManager();
      var dav = new webdav.lib.Client();
      var httpStatus = webdav.lib.HttpStatus;
      var httpStatusText = webdav.lib.HttpStatus.text;

      var assertMoveAnotherTreeOverWrite = function(statusCode, content, headers) {
        assertEquals('StatusCode?', httpStatus.NO_CONTENT, statusCode);
        assertTrue('No Content?', goog.string.isEmptySafe(content));
        dav._delete(parentDir, asyncContinue, {
          xhrId: goog.string.createUniqueString(), request: mgr},
          goog.partial(logging, testId));
      };
      var assertMoveAnotherTreeFalse = function(statusCode, content, headers) {
        assertNotContains('StatusCode?', statusCode,
          [httpStatus.CREATED, httpStatus.NO_CONTENT]);
        dav.move(parentDir2, dstDir, assertMoveAnotherTreeOverWrite, {
          xhrId: goog.string.createUniqueString(), request: mgr,
          overwrite: true},
          goog.partial(logging, testId));
      };
      var assertMove = function(statusCode, content, headers) {
        assertEquals('StatusCode?', httpStatus.CREATED, statusCode);
        assertNotNullNorUndefined('Location?', headers['Location']);
        assertTrue('Location match:', goog.string.endsWith(headers['Location'], dstDir));
        dav.move(dstDir, parentDir2, assertMoveAnotherTreeFalse, {
          xhrId: goog.string.createUniqueString(), request: mgr,
          overwrite: false},
          goog.partial(logging, testId));
      };
      var executeMove = function(statusCode, content, headers) {
        dav.move(dir, dstDir, assertMove, {
          xhrId: goog.string.createUniqueString(), request: mgr},
          goog.partial(logging, testId));
      };
      var createMoveDir = function(statusCode, content, headers) {
        dav.mkcol(dir, executeMove, {
          xhrId: goog.string.createUniqueString(), request: mgr});
      };
      var createAnotherParentDir = function(StatusCode, content, headers) {
        dav.mkcol(parentDir2, createMoveDir, {
          xhrId: goog.string.createUniqueString(), request: mgr});
      };

      dav.mkcol(parentDir, createAnotherParentDir, {
        xhrId: goog.string.createUniqueString(), request: mgr});
    }

    function testCopy() {
      var testId = 'Copy';

      asyncTestCase.waitForAsync(testId);

      var parentDir = '/mydav/parent/';
      var dir = '/mydav/parent/copySrc/';
      var dstDir = '/mydav/parent/copyDst/';
      var mgr = new goog.net.XhrManager();
      var dav = new webdav.lib.Client();
      var httpStatus = webdav.lib.HttpStatus;
      var httpStatusText = webdav.lib.HttpStatus.text;

      var assertCopyOverWriteFalse = function(statusCode, content, headers) {
        assertNotEquals('StatusCode?', httpStatus.NO_CONTENT, statusCode);
        dav._delete(parentDir, asyncContinue, {
          xhrId: goog.string.createUniqueString(), request: mgr},
          goog.partial(logging, testId));
      };
      var assertCopyOverWrite = function(statusCode, content, headers) {
        assertEquals('StatusCode?', httpStatus.NO_CONTENT, statusCode);
        assertTrue('No Content?', goog.string.isEmptySafe(content));
        dav.copy(dir, dstDir, assertCopyOverWriteFalse, {
          xhrId: goog.string.createUniqueString(), request: mgr,
          overwrite: false},
          goog.partial(logging, testId));
      };
      var assertCopy = function(statusCode, content, headers) {
        assertEquals('StatusCode?', httpStatus.CREATED, statusCode);
        assertNotNullNorUndefined('Location?', headers['Location']);
        assertTrue('Location match:',
          goog.string.endsWith(headers['Location'], dstDir));
        dav.copy(dstDir, dir, assertCopyOverWrite, {
          xhrId: goog.string.createUniqueString(), request: mgr,
          overwrite: true},
          goog.partial(logging, testId));
      };
      var callbackRequest2 = function(statusCode, content, headers) {
        dav.copy(dir, dstDir, assertCopy, {
          xhrId: goog.string.createUniqueString(), request: mgr},
          goog.partial(logging, testId));
      };
      var callbackRequest1 = function(statusCode, content, headers) {
        dav.mkcol(dir, callbackRequest2, {
          xhrId: goog.string.createUniqueString(), request: mgr});
      };

      dav.mkcol(parentDir, callbackRequest1, {
        xhrId: goog.string.createUniqueString(), request: mgr});
    }
  </script>
</body>
</html>
